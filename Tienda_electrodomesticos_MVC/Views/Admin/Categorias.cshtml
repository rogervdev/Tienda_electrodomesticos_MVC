@model List<Categoria>
@inject IConfiguration Configuration

@{
    var api = Configuration["ApiBaseUrl"];
}
@{
    ViewData["Title"] = "Gestión de Categorías";
    var categorias = Model ?? new List<Categoria>();
    var successMsg = TempData["successMsg"] as string;
    var errorMsg = TempData["errorMsg"] as string;
}

<div class="container-fluid py-5 mt-4">
    <div class="row g-4">

        @* MENSAJES *@
        @if (!string.IsNullOrEmpty(successMsg))
        {
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fa-solid fa-circle-check me-2"></i> @successMsg
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMsg))
        {
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i> @errorMsg
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }

        <!-- FORMULARIO -->
        <div class="col-md-4">
            <div class="card border-0 rounded-4 shadow-sm h-100">
                <div class="card-header bg-primary text-white text-center rounded-top">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-folder-plus me-2"></i>Agregar Categoría
                    </h5>
                </div>

                <div class="card-body p-4">
                    <form asp-controller="Admin"
                          asp-action="GuardarCategoria"
                          method="post"
                          enctype="multipart/form-data">

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre</label>
                            <input name="Nombre" class="form-control" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold d-block">Estado</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="IsActive" value="true" checked />
                                <label class="form-check-label">Activo</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="IsActive" value="false" />
                                <label class="form-check-label">Inactivo</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Imagen</label>
                            <input type="file" id="fileInput" name="File" class="form-control" accept="image/*" required />
                        </div>

                        <div class="mb-3 text-center">
                            <img id="preview" class="img-fluid rounded shadow-sm" style="max-height:120px" />
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary w-100">
                                <i class="fa-solid fa-save me-2"></i>Guardar
                            </button>

                            <a asp-controller="Admin"
                               asp-action="Index"
                               class="btn btn-secondary w-100">
                                <i class="fa-solid fa-arrow-left me-2"></i>Panel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TABLA -->
        <div class="col-md-8">
            <div class="card border-0 rounded-4 shadow-sm">
                <div class="card-header bg-primary text-white text-center rounded-top">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-list me-2"></i>Lista de Categorías
                    </h5>
                </div>

                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Imagen</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < categorias.Count; i++)
                                {
                                    var cat = categorias[i];
                                    <tr>
                                        <td>@(i + 1)</td>
                                        <td>@cat.Nombre</td>
                                        <td>
                                            <span class="badge @(cat.IsActive ? "bg-success" : "bg-danger")">
                                                @(cat.IsActive ? "Activo" : "Inactivo")
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <img src="@($"{api}/images/category_img/{cat.ImagenNombre}")"
                                                 class="rounded-circle border"
                                                 style="width:50px;height:50px;object-fit:cover" />

                                        </td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-2">

                                                <!-- EDITAR -->
                                                <a asp-controller="Admin"
                                                   asp-action="EditarCategoria"
                                                   asp-route-id="@cat.Id"
                                                   class="btn btn-sm btn-info">
                                                    <i class="fa-solid fa-pen"></i>
                                                </a>

                                                <!-- ELIMINAR -->
                                                <form asp-controller="Admin"
                                                      asp-action="EliminarCategoria"
                                                      asp-route-id="@cat.Id"
                                                      method="post"
                                                      onsubmit="return confirmarEliminar();">
                                                    <button class="btn btn-sm btn-danger">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                </form>

                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        const fileInput = document.getElementById("fileInput");
        const preview = document.getElementById("preview");

        fileInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => preview.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });

        function confirmarEliminar() {
            return confirm("¿Seguro que deseas eliminar esta categoría?");
        }
    </script>
}
